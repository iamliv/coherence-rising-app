<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Coherence Rising ‚Äî Breath of Faith</title>

<!-- ===========================
     FONTS (SAFE TO CHANGE)
     To change fonts, swap the Google Fonts line or remove it.
=========================== -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  /* ===========================
     COLOR TOKENS (EDIT HERE)
     Day vs Night are below; these drive the whole theme.
  =========================== */
  :root{
    --gold:#F5E6A1; --lav:#C8BFE7; --olive:#A3B18A; --taupe:#D8CFC4; --sky:#A7C7E7;
    --slate:#7D8C8C; --ivory:#FDF6EC; --ink:#2E3131; --ink-weak:#4b5563;
    --bg:#FDF6EC;            /* LIGHTER DAY BACKGROUND */
    --card:#ffffff;          /* BRIGHT CARDS */
    --accent:var(--olive);
    --orb:#ffffffc0; --cue:#1f2937; --viz-line:#24423a;
    --r:16px; --shadow:0 8px 24px rgba(0,0,0,.08);
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0e1012; --card:#13161a; --ink:#e6e9ee; --ink-weak:#aab2bf; --accent:#7aa57a; --orb:#ffffff26; --cue:#e6e9ee; --viz-line:#7aa57a; }
  }
  body[data-theme="night"]{
    --bg:#0b0e11;            /* DARKER NIGHT BG */
    --card:#101317;          /* DARKER NIGHT CARD */
    --ink:#e5ecf3; --ink-weak:#a6b0bf;
    --accent:#7aa57a; --orb:#ffffff22; --cue:#eef3f8; --viz-line:#6fa46f;
  }

  /* ===========================
     GLOBAL LAYOUT + BASICS
  =========================== */
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink)}
  *{box-sizing:border-box}
  #cr-app{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased;max-width:980px;margin:0 auto;padding:1rem 1rem 10px}
  .card{background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);padding:1rem;margin:1rem 0}
  .header{border-radius:24px;text-align:center;padding:28px 20px;background:linear-gradient(135deg,var(--sky),var(--lav));color:#102232}
  .header h1{margin:.3rem 0 0;font-weight:700;font-size:clamp(30px,7vw,48px);line-height:1.12}
  .header .byline{font-size:clamp(14px,2.7vw,16px);font-weight:600;opacity:.9;margin:.2rem 0 .6rem}
  .header .subtitle{margin:0;font-size:clamp(18px,3.3vw,22px);line-height:1.5;opacity:.9}
  nav a{display:inline-block;background:#ffffffd9;color:#1f2937;border:1px solid #0001;border-radius:999px;padding:.35rem .75rem;text-decoration:none}
  .row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
  .actions{display:flex;gap:.5rem;flex-wrap:wrap}
  .btn{border:0;border-radius:12px;padding:.6rem .9rem;background:var(--accent);color:#132b16;font-weight:600;cursor:pointer;box-shadow:0 2px 8px rgba(163,177,138,.35)}
  .btn.secondary{background:var(--taupe);color:#2b2b2b}
  .btn.ghost{background:transparent;border:1px solid #0003;color:var(--ink)}
  .select{border:1px solid #0003;background:var(--card);color:var(--ink);border-radius:10px;padding:.5rem .6rem}
  .timer{font-variant-numeric:tabular-nums;font-size:2rem;font-weight:700}

  /* ===========================
     INTRO CALLOUTS (READABLE)
     ***** THIS REPLACED THE GRADIENT BOXES *****
     Edit text in HTML below, styles here.
  =========================== */
  .intro{
    background:#ffffff; border:1px solid #00000010; border-radius:12px;
    padding:.95rem 1rem; color:#1f2a30; box-shadow:0 4px 14px rgba(0,0,0,.05)
  }
  body[data-theme="night"] .intro{
    background:#151a1f; border-color:#ffffff14; color:#e7eef5; box-shadow:0 6px 18px rgba(0,0,0,.35)
  }

  /* ===========================
     SECTION DIVIDER (BETWEEN MAJOR SECTIONS)
     Inserted before Pomodoro.
  =========================== */
  .section-divider{
    margin:28px auto 12px; display:flex; align-items:center; gap:10px;
    opacity:.9; max-width:980px; padding:0 1rem;
  }
  .section-divider .line{flex:1; height:1px; background:linear-gradient(90deg, transparent, #7D8C8C55, transparent)}
  .section-divider .mark{font-weight:700; color:#7D8C8C; letter-spacing:.02em}

  /* ===========================
     BREATHWORK VISUALS
  =========================== */
  .viz-wrap{
    position:relative;width:100%;
    height:min(72vh, 95vw);
    border-radius:14px;overflow:hidden;
    background:radial-gradient(100% 130% at 20% 0%, var(--gold), transparent 60%),
               radial-gradient(120% 100% at 100% 100%, var(--lav), transparent 55%),
               radial-gradient(120% 100% at 0% 100%, var(--olive), transparent 55%);
  }
  body[data-theme="night"] .viz-wrap{background:linear-gradient(180deg,#0c1210,#0a0f0d)}

  .viz-scale{
    position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(1);
    transform-origin:center center;will-change:transform;transition:transform 3.6s ease-in-out;
  }

  .orb{width:min(68vmin, 92vw);height:min(68vmin, 92vw);background:var(--orb);
       border:2px solid #0003;border-radius:50%;
       box-shadow:inset 0 0 100px rgba(167,199,231,.25), 0 10px 30px rgba(0,0,0,.12)}

  .svg-box{width:min(74vmin, 96vw);height:min(74vmin, 96vw)}
  .svg-fit{width:100%;height:100%}
  .cross-shape{fill:none;stroke:var(--viz-line);stroke-width:40;stroke-linecap:round;stroke-linejoin:round;filter:drop-shadow(0 6px 16px rgba(0,0,0,.25))}
  .cross-glow{stroke:rgba(255,255,255,.08);stroke-width:80}
  .branches line{stroke:var(--viz-line);stroke-width:1.6;stroke-linecap:round}
  #starCanvas{display:block;width:100%;height:100%}

  .cue-center{
    position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    text-align:center;font-weight:700;letter-spacing:.2px;color:var(--cue);
    font-size:clamp(20px,5vw,28px);padding:.25rem .5rem;border-radius:8px;background:transparent;
    text-shadow:0 1px 2px rgba(0,0,0,.25);pointer-events:none;
  }
  .hint{position:absolute;left:50%;bottom:10px;transform:translateX(-50%);background:#0002;color:#fff;
        padding:.25rem .6rem;border-radius:999px;font-size:.85rem}

  /* ===========================
     PROGRESS BAR (THICKER)
     Edit thickness by changing height below.
  =========================== */
  .bar{height:18px;background:#00000012;border-radius:999px;overflow:hidden;border:1px solid #0000001a}
  .bar > .fill{
    height:100%;width:0;background:linear-gradient(90deg, var(--olive), var(--sky));
    transition:width .15s linear; box-shadow:inset 0 0 8px rgba(255,255,255,.25);
  }
  body[data-theme="night"] .bar{background:#ffffff10;border-color:#ffffff20}

  footer{text-align:center;color:var(--ink-weak);padding:10px 12px}
  @media (min-width:860px){ .grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem} }

  /* Accessibility helper (hidden label) */
  .sr-only{position:absolute;width:1px;height:1px;margin:-1px;border:0;padding:0;clip:rect(0 0 0 0);overflow:hidden}
</style>
</head>
<body>
<div id="cr-app" role="application" aria-label="Coherence Rising: Breath of Faith App">
  <!-- ===========================
       HEADER (EDIT TITLES/TAGLINE HERE)
  =========================== -->
  <header class="header card">
    <h1>Breath of Faith</h1>
    <p class="byline">by Coherence Rising</p>
    <p class="subtitle">A sacred space for prayer, focus, and renewal</p>
    <nav class="row" style="justify-content:center">
      <a href="#breathwork">Breathwork</a>
      <a href="#pomodoro">Pomodoro</a>
      <button id="nightToggle" class="btn ghost" style="margin-left:.5rem">Night mode</button>
    </nav>
  </header>

  <!-- ===========================
       BREATHWORK SECTION
       *** EDIT INTRO TEXT + MUSIC BLURB HERE ***
  =========================== -->
  <section id="breathwork" class="card" aria-labelledby="breathwork-title">
    <h2 id="breathwork-title" style="margin:0 0 .5rem;font-size:1.15rem">Breathwork Break</h2>

    <div class="intro" style="margin:.5rem 0 1rem">
      <!-- **** EDITABLE COPY START **** -->
      <strong>Breath is life ‚Äî and how we breathe shapes how we feel.</strong>
      Intentional breathwork calms the nervous system, reduces stress, and helps the mind enter a state of focus and prayer.
      As you breathe slowly and deeply, your heart rate steadies and your body shifts into a restorative ‚Äúrest and digest‚Äù state.
      Use these patterns to center yourself and create space for God‚Äôs presence.
      <!-- **** EDITABLE COPY END **** -->
    </div>

    <p style="margin:.25rem 0 .75rem">Pick a visual and a breathing pattern. Go fullscreen if you like. Follow the centered cue.</p>

    <!-- Controls -->
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="actions" role="group" aria-label="Breath durations">
        <!-- Change label text if desired; data-mins controls duration -->
        <button class="btn" data-mins="3">3 min</button>
        <button class="btn" data-mins="5">5 min</button>
        <button class="btn" data-mins="10">10 min</button>
        <button class="btn" data-mins="15">15 min</button>
        <button class="btn" data-mins="20">20 min</button>
        <button id="breathPause" class="btn secondary" disabled>Pause</button>
      </div>
      <div class="row">
        <!-- PATTERN OPTIONS: change labels safely; values map to JS (see PATTERNS in script) -->
        <select id="patternSelect" class="select" aria-label="Breathing pattern">
          <option value="box-3">Box: 3-3-3-3</option>
          <option value="box-4" selected>Box: 4-4-4-4</option>
          <option value="box-6">Box: 6-6-6-6</option>
          <option value="even-4">Even: 4-4</option>
          <option value="even-6">Even: 6-6</option>
          <option value="even-8">Even: 8-8</option>
        </select>
        <!-- VISUAL MODES: orb, cross, branches, starfield -->
        <select id="vizSelect" class="select" aria-label="Visual" style="margin-left:.5rem">
          <option value="orb" selected>Orb</option>
          <option value="cross">Cross</option>
          <option value="branches">Branches</option>
          <option value="star">Starfield</option>
        </select>
        <button id="fsToggle" class="btn ghost" aria-label="Toggle Fullscreen" style="margin-left:.5rem">Fullscreen</button>
      </div>
    </div>

    <div class="grid" style="margin-top:.75rem">
      <div>
        <div class="timer" id="breathTime">00:00</div>

        <div id="vizWrap" class="viz-wrap" tabindex="0" aria-live="polite">
          <!-- Unified scale group (ALL visuals scale together) -->
          <div id="vizScale" class="viz-scale">
            <!-- Orb -->
            <div id="orbBox" class="orb" aria-hidden="false"></div>

            <!-- Protestant Cross (transparent SVG) -->
            <div id="crossBox" class="svg-box" aria-hidden="true" style="display:none">
              <svg id="crossSVG" class="svg-fit" viewBox="0 0 1000 1000" role="img" aria-label="Protestant Christian cross">
                <g>
                  <path class="cross-glow" d="M500 140 L500 860 M250 430 L750 430"/>
                  <path class="cross-shape" d="M500 160 L500 840 M280 430 L720 430"/>
                </g>
              </svg>
            </div>

            <!-- Fractal-like Branches (transparent SVG) -->
            <div id="branchBox" class="svg-box" aria-hidden="true" style="display:none">
              <svg id="branchSVG" class="svg-fit" viewBox="0 0 1000 1000" role="img" aria-label="Fractal branches">
                <g id="branchGroup" class="branches"></g>
              </svg>
            </div>

            <!-- Gentle Starfield (transparent canvas) -->
            <div id="starBox" class="svg-box" aria-hidden="true" style="display:none">
              <canvas id="starCanvas" width="1000" height="1000" aria-label="Gentle starfield"></canvas>
            </div>
          </div>

          <!-- Centered cue (shared by all visuals) -->
          <div id="cue" class="cue-center">Ready to begin</div>
          <div class="hint fade">Press a duration to start</div>
        </div>
      </div>

      <div>
        <!-- ***** MUSIC BLURB (EDIT TEXT OR HIDE THIS <p>) ***** -->
        <p style="margin:.5rem 0 .35rem; font-size:.95rem; color:var(--ink-weak)">
          Playlists by <strong>Coherence Rising</strong>, curated to accompany breathwork.
          Prefer silence? Simply leave the player paused.
        </p>
        <!-- ***** YOUTUBE PLAYLIST (EDIT list= ID TO CHANGE) ***** -->
        <iframe
          width="100%" height="300"
          src="https://www.youtube.com/embed/videoseries?list=OLAK5uy_l4UsJuLqbFOSXeOzTEjw_Qfu3WyWvuxgo&rel=0&modestbranding=1&playsinline=1"
          title="Breathwork Album"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          referrerpolicy="strict-origin-when-cross-origin"
          allowfullscreen></iframe>
        <!-- ***** OPTIONAL SPOTIFY LINK (EDIT URL) ***** -->
        <p style="margin:.35rem 0 0; font-size:.9rem; color:var(--ink-weak)">
          Also on <a href="https://open.spotify.com/album/59QgbMZznJd7gAQloXLlk0" target="_blank" rel="noopener">Spotify</a>.
        </p>
      </div>
    </div>
  </section>

  <!-- ===========================
       SECTION DIVIDER (VISUAL SEPARATION)
  =========================== -->
  <div class="section-divider" aria-hidden="true">
    <span class="line"></span><span class="mark">Focus Session</span><span class="line"></span>
  </div>

  <!-- ===========================
       POMODORO SECTION
       *** EDIT INTRO TEXT + MUSIC BLURB HERE ***
  =========================== -->
  <section id="pomodoro" class="card" aria-labelledby="pomodoro-title">
    <h2 id="pomodoro-title" style="margin:0 0 .5rem;font-size:1.15rem">Pomodoro Focus</h2>

    <div class="intro" style="margin:.5rem 0 1rem">
      <!-- **** EDITABLE COPY START **** -->
      <strong>Small bursts of focus lead to big breakthroughs.</strong>
      The Pomodoro rhythm helps you work with energy, not against it: focused intervals followed by short breaks prevent burnout and improve concentration.
      Pair your work with Scripture and calming music to keep both your spirit and productivity strong.
      <!-- **** EDITABLE COPY END **** -->
    </div>

    <p style="margin:.25rem 0 .75rem">25 minutes on, then 5 minutes off. After four Pomodoros, enjoy a 15-minute long break.</p>

    <div class="row" style="align-items:center;justify-content:space-between">
      <div class="row" style="gap:1rem;align-items:baseline">
        <div class="timer" id="pomo">25:00</div>
        <div id="pomoStatus" style="color:var(--ink-weak);font-weight:600">Work ‚Äî Pomodoro 1 of 4</div>
      </div>
      <div class="actions">
        <button id="pomoStart" class="btn">Start</button>
        <button id="pomoPause" class="btn secondary">Pause</button>
        <button id="pomoReset" class="btn ghost">Reset</button>
        <a id="pomoSkip" href="#" class="btn ghost" style="text-decoration:none">Skip break</a>
      </div>
    </div>

    <!-- PROGRESS BAR (THICKER + MATCHED STYLE) -->
    <div style="margin:.6rem 0 .25rem;display:flex;justify-content:space-between;align-items:center">
      <div id="pomoBarLabel" style="font-size:.9rem;color:var(--ink-weak)">Block progress (Work + Short break)</div>
      <div id="pomoRound" style="font-size:.9rem;color:var(--ink-weak)">Round 1 / 4</div>
    </div>
    <div class="bar" aria-label="Pomodoro progress" role="progressbar" aria-valuemin="0" aria-valuemax="100">
      <div id="pomoFill" class="fill" style="width:0%"></div>
    </div>

    <div id="pomoVerse" class="row" style="gap:.4rem;margin:.8rem 0;color:var(--ink-weak)">
      ‚ÄúCommit your work to the LORD, and your plans will be established.‚Äù ‚Äî Proverbs 16:3
    </div>

    <!-- ***** MUSIC BLURB (EDIT TEXT OR HIDE THIS <p>) ***** -->
    <p style="margin:.5rem 0 .35rem; font-size:.95rem; color:var(--ink-weak)">
      Focus music by <strong>Coherence Rising</strong>. If you prefer no audio, keep the player paused.
    </p>
    <!-- ***** YOUTUBE PLAYLIST (EDIT list= ID TO CHANGE) ***** -->
    <iframe
      style="border-radius:12px"
      src="https://www.youtube.com/embed/videoseries?list=OLAK5uy_mYQTMuHxJs17LZApCnxc0ak0E73-0jLwU&rel=0&modestbranding=1&playsinline=1"
      width="100%" height="300" frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      referrerpolicy="strict-origin-when-cross-origin"
      title="Focus Album" allowfullscreen></iframe>
    <!-- ***** OPTIONAL SPOTIFY LINK (EDIT URL) ***** -->
    <p style="margin:.35rem 0 0; font-size:.9rem; color:var(--ink-weak)">
      Also on <a href="https://open.spotify.com/album/3lL4wCD0MDpEW2C3wf1DZH" target="_blank" rel="noopener">Spotify</a>.
    </p>

    <!-- Completion toast -->
    <div id="toast" style="display:none;margin-top:10px;padding:10px;border:1px solid #0003;border-radius:10px;background:var(--card)">
      Pomodoro complete! Take a short break. üåø
    </div>
  </section>

  <!-- ===========================
       FEEDBACK (PLACEHOLDER)
       ***** DO NOT IMPLEMENT YET *****
       When ready for Option B (Ontraport modal), we‚Äôll replace this card with:
       - A button that opens a modal
       - An iframe with your Ontraport form embed
       - Close button + auto-height script
  =========================== -->
  <section class="card" id="feedback">
    <h2 style="margin:0 0 .5rem;font-size:1.15rem">Feedback</h2>
    <p style="margin:.25rem 0 .75rem">We welcome your thoughts to improve this app. (Email signup modal coming soon.)</p>
    <!-- TEMP BUTTON (NO ACTION YET) -->
    <button class="btn ghost" disabled title="Coming soon">Share feedback & get updates</button>
  </section>
</div>

<!-- ===========================
     FOOTER (EDITABLE TEXT)
=========================== -->
<footer>
  <p><strong>Coherence Rising</strong> ¬∑ Music & Meditations</p>
  <p style="font-size:.9rem">¬© <span id="year"></span> Coherence Rising ‚Äî Prayer & Productivity Companion</p>
</footer>

<script>
  // ===========================
  // YEAR (AUTO)
  // ===========================
  document.getElementById('year').textContent = new Date().getFullYear();

  // ===========================
  // NIGHT MODE TOGGLE
  // ===========================
  (function(){
    var nightBtn = document.getElementById('nightToggle');
    if (!nightBtn) return;
    nightBtn.addEventListener('click', function(){
      var isNight = document.body.getAttribute('data-theme') === 'night';
      if (isNight) { document.body.removeAttribute('data-theme'); nightBtn.textContent = 'Night mode'; }
      else { document.body.setAttribute('data-theme','night'); nightBtn.textContent = 'Day mode'; }
    });
  })();

  // ===========================
  // SMALL UTILS
  // ===========================
  var $=function(s,r){return (r||document).querySelector(s)}, $$=function(s,r){return Array.prototype.slice.call((r||document).querySelectorAll(s));};
  var pad=function(n){return String(n).padStart(2,'0')};
  var fmt=function(ms){var s=Math.max(0,Math.floor(ms/1000));return pad(Math.floor(s/60))+':'+pad(s%60)};

  /* =======================================================
     BREATHWORK (VISUALS + PATTERNS)
     ***** SAFE AREA TO EDIT: PATTERN DURATIONS + CUE TEXT *****
  ======================================================= */
  (function(){
    var timeEl=$('#breathTime'), cueEl=$('#cue');
    var vizWrap=$('#vizWrap'), vizScale=$('#vizScale');
    var vizSelect=$('#vizSelect'), patternSelect=$('#patternSelect');
    var pauseBtn=$('#breathPause'); var durButtons=$$('#breathwork [data-mins]');

    var orbBox=$('#orbBox'), crossBox=$('#crossBox'), branchBox=$('#branchBox'), starBox=$('#starBox');
    var branchGroup=$('#branchGroup');
    var starCanvas=$('#starCanvas'), starCtx = starCanvas && starCanvas.getContext ? starCanvas.getContext('2d') : null;

    // ***** EDIT PATTERN DURATIONS HERE (ms) *****
    var PATTERNS={
      'box-3':  [{name:'inhale',ms:3000,scale:1.85},{name:'hold',ms:3000,scale:null},{name:'exhale',ms:3000,scale:0.9},{name:'hold',ms:3000,scale:null}],
      'box-4':  [{name:'inhale',ms:4000,scale:1.85},{name:'hold',ms:4000,scale:null},{name:'exhale',ms:4000,scale:0.9},{name:'hold',ms:4000,scale:null}],
      'box-6':  [{name:'inhale',ms:6000,scale:1.85},{name:'hold',ms:6000,scale:null},{name:'exhale',ms:6000,scale:0.9},{name:'hold',ms:6000,scale:null}],
      'even-4': [{name:'inhale',ms:4000,scale:1.85},{name:'exhale',ms:4000,scale:0.9}],
      'even-6': [{name:'inhale',ms:6000,scale:1.85},{name:'exhale',ms:6000,scale:0.9}],
      'even-8': [{name:'inhale',ms:8000,scale:1.85},{name:'exhale',ms:8000,scale:0.9}],
    };
    var REST_SCALE = 1.05;
    var phases = PATTERNS['box-4']; // default

    var running=false, paused=false;
    var totalEnd=null, remaining=null;
    var phaseIdx=0, phaseEnd=null, phaseRemaining=null;
    var tickIv=null;

    // ***** SWITCH VISUAL MODE *****
    function show(mode){
      orbBox.style.display    = (mode==='orb') ? 'block' : 'none';
      crossBox.style.display  = (mode==='cross') ? 'block' : 'none';
      branchBox.style.display = (mode==='branches') ? 'block' : 'none';
      starBox.style.display   = (mode==='star') ? 'block' : 'none';
      if(mode==='star') startStars(); else stopStars();
    }
    vizSelect.addEventListener('change',function(){ show(vizSelect.value); });
    show('orb');

    // ***** DRAW BRANCHES ONCE *****
    function drawBranches(){
      branchGroup.innerHTML='';
      var W=1000,H=1000;
      function seg(x1,y1,len,ang,depth){
        if(depth<=0||len<6) return;
        var x2=x1+Math.cos(ang)*len, y2=y1+Math.sin(ang)*len;
        var ln=document.createElementNS('http://www.w3.org/2000/svg','line');
        ln.setAttribute('x1',x1); ln.setAttribute('y1',y1);
        ln.setAttribute('x2',x2); ln.setAttribute('y2',y2);
        ln.setAttribute('opacity', String(0.25+0.75*(depth/9)));
        branchGroup.appendChild(ln);
        var nlen=len*(0.68+Math.random()*0.08);
        seg(x2,y2,nlen,ang-0.6+Math.random()*0.15,depth-1);
        seg(x2,y2,nlen,ang+0.55-Math.random()*0.15,depth-1);
      }
      seg(W*0.5,H*0.98,190,-Math.PI/2,10);
      seg(W*0.2,H*0.95,135,-Math.PI/2.2,9);
      seg(W*0.8,H*0.96,140,-Math.PI/1.8,9);
    }
    drawBranches();

    // ***** STARFIELD (gentle drift) *****
    var stars=[], animId=null, lastT=0, starDrift=0.03;
    function initStars(){
      if(!starCanvas || !starCtx) return;
      var count = 180;
      var W = starCanvas.width, H = starCanvas.height;
      stars = new Array(count);
      for(var i=0;i<count;i++){
        stars[i] = {
          x: Math.random()*W, y: Math.random()*H,
          r: 0.7 + Math.random()*1.8,
          a: Math.random()*Math.PI*2,
          tw: 0.001 + Math.random()*0.002,
          z: 0.5 + Math.random()*1.5
        };
      }
    }
    function renderStars(dt){
      if(!starCanvas || !starCtx) return;
      var W = starCanvas.width, H = starCanvas.height;
      starCtx.clearRect(0,0,W,H);
      for(var i=0;i<stars.length;i++){
        var s=stars[i];
        s.a += s.tw * dt;
        s.y += starDrift * s.z * dt * 0.02;
        if(s.y > H+5) s.y = -5;
        var glow = 0.6 + 0.4*Math.sin(s.a);
        starCtx.globalAlpha = 0.25 + 0.75*glow;
        starCtx.beginPath(); starCtx.arc(s.x,s.y,s.r,0,Math.PI*2);
        starCtx.fillStyle = '#c9d6ff'; starCtx.fill();
      }
      starCtx.globalAlpha = 1;
    }
    function tickStars(ts){
      if(!lastT) lastT = ts;
      var dt = ts - lastT; lastT = ts;
      renderStars(dt);
      animId = window.requestAnimationFrame(tickStars);
    }
    function startStars(){ if(animId) return; initStars(); lastT=0; animId=window.requestAnimationFrame(tickStars); }
    function stopStars(){ if(animId) window.cancelAnimationFrame(animId); animId=null; }

    // ***** CUE TEXT (EDIT WORDING HERE) *****
    function setCue(name){
      if(!cueEl) return;
      if(name==='inhale') cueEl.textContent='Inhale ‚Äî Be still';
      else if(name==='hold') cueEl.textContent='Hold ‚Äî and know';
      else if(name==='exhale') cueEl.textContent='Exhale ‚Äî and know';
      else cueEl.textContent='Ready to begin';
    }

    // ***** SCALE PER PHASE (EDIT SCALE VALUES ABOVE IN PATTERNS) *****
    function setScaleForPhase(phase){
      vizScale.style.transitionDuration = (phase.ms/1000)+'s';
      if(phase.scale!=null){
        var s = phase.scale;
        vizScale.style.transform = 'translate(-50%,-50%) scale('+s+')';
        starDrift = (s-0.9) * 0.06 + 0.02;
      }
    }
    function resetScale(){
      vizScale.style.transitionDuration = '0.4s';
      vizScale.style.transform = 'translate(-50%,-50%) scale('+REST_SCALE+')';
      starDrift = 0.03;
    }
    resetScale();

    function stopTick(){ if(tickIv){ clearInterval(tickIv); tickIv=null; } }

    function update(){
      var now=Date.now();
      var rem=Math.max(0, totalEnd-now);
      if(timeEl) timeEl.textContent=fmt(rem);

      if(rem<=0){
        stopTick(); running=false; paused=false;
        if(pauseBtn){ pauseBtn.disabled=true; pauseBtn.textContent='Pause'; }
        setCue('ready'); if(timeEl) timeEl.textContent='00:00';
        resetScale(); return;
      }
      if(now>=phaseEnd){
        phaseIdx=(phaseIdx+1)%phases.length;
        var p=phases[phaseIdx];
        phaseEnd=now+p.ms; setCue(p.name); setScaleForPhase(p);
      }
    }
    function start(mins){
      var total = mins*60*1000;
      running=true; paused=false;
      totalEnd = Date.now()+total;
      phaseIdx=0; var p=phases[phaseIdx]; phaseEnd=Date.now()+p.ms;
      setCue(p.name); setScaleForPhase(p);
      if(pauseBtn){ pauseBtn.disabled=false; pauseBtn.textContent='Pause'; }
      stopTick(); tickIv=setInterval(update, 200); update();
    }
    function pause(){
      if(!running || paused) return;
      var now=Date.now();
      remaining = Math.max(0, totalEnd-now);
      phaseRemaining = Math.max(0, phaseEnd-now);
      paused=true; stopTick();
      if(pauseBtn) pauseBtn.textContent='Resume';
    }
    function resume(){
      if(!running || !paused) return;
      var now=Date.now();
      totalEnd = now + remaining;
      phaseEnd  = now + phaseRemaining;
      paused=false; if(pauseBtn) pauseBtn.textContent='Pause';
      stopTick(); tickIv=setInterval(update, 200); update();
    }

    // Pattern + visual listeners
    patternSelect.addEventListener('change', function(){
      phases = PATTERNS[patternSelect.value] || PATTERNS['box-4'];
      if(running){ pause(); resume(); }
    });
    var fsBtn=$('#fsToggle');
    function enterFS(el){
      try{
        if(el.requestFullscreen) el.requestFullscreen();
        else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
        else if(el.msRequestFullscreen) el.msRequestFullscreen();
      }catch(e){}
    }
    function exitFS(){
      try{
        if(document.exitFullscreen) document.exitFullscreen();
        else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
        else if(document.msExitFullscreen) document.msExitFullscreen();
      }catch(e){}
    }
    function toggleFS(){
      if(!document.fullscreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement){
        enterFS(vizWrap);
      }else{
        exitFS();
      }
    }
    if(fsBtn) fsBtn.addEventListener('click', toggleFS);

    durButtons.forEach(function(btn){
      btn.addEventListener('click', function(){
        var mins=parseInt(btn.getAttribute('data-mins'),10)||3;
        start(mins);
      });
    });
    if(pauseBtn) pauseBtn.addEventListener('click', function(){ if(!running) return; paused?resume():pause(); });
  })();

  /* =======================================================
     POMODORO ‚Äî CYCLES + PROGRESS
     ***** SAFE AREA TO EDIT: DURATIONS + LABEL TEXT *****
  ======================================================= */
  (function(){
    var pomo=$('#pomo'), start=$('#pomoStart'), pause=$('#pomoPause'), reset=$('#pomoReset'),
        status=$('#pomoStatus'), verse=$('#pomoVerse'), toast=$('#toast'),
        skip=$('#pomoSkip'), barFill=$('#pomoFill'), barLabel=$('#pomoBarLabel'), roundEl=$('#pomoRound');

    // ***** EDIT SCRIPTURE LIST (ADD/REMOVE LINES) *****
    var verses=[
      '‚ÄúBe still, and know that I am God.‚Äù ‚Äî Psalm 46:10',
      '‚ÄúThe LORD is my shepherd; I shall not want.‚Äù ‚Äî Psalm 23:1',
      '‚ÄúDraw near to God, and He will draw near to you.‚Äù ‚Äî James 4:8',
      '‚ÄúCast all your anxiety on Him because He cares for you.‚Äù ‚Äî 1 Peter 5:7',
      '‚ÄúRejoice in hope, be patient in tribulation, be constant in prayer.‚Äù ‚Äî Romans 12:12',
      '‚ÄúYour word is a lamp to my feet and a light to my path.‚Äù ‚Äî Psalm 119:105',
      '‚ÄúCommit your work to the LORD, and your plans will be established.‚Äù ‚Äî Proverbs 16:3',
      '‚ÄúIn all your ways acknowledge Him, and He will make straight your paths.‚Äù ‚Äî Proverbs 3:6',
    ];

    // ***** EDIT DURATIONS HERE (ms) *****
    var WORK=25*60*1000, SHORT=5*60*1000, LONG=15*60*1000, BLOCK=WORK+SHORT;

    var mode='work'; // 'work' | 'short' | 'long'
    var round=1;     // 1..4
    var ends=null, rest=null, iv=null, started=false;

    function setVerse(){ if(verse) verse.textContent = verses[Math.floor(Math.random()*verses.length)]; }

    // ***** STATUS LINE TEXT *****
    function setStatus(){
      if(mode==='work'){
        status.textContent = 'Work ‚Äî Pomodoro '+round+' of 4';
        roundEl.textContent = 'Round '+round+' / 4';
        barLabel.textContent = 'Block progress (Work + Short break)';
      }else if(mode==='short'){
        status.textContent = 'Short Break ‚Äî breathe & stretch';
        roundEl.textContent = 'Round '+round+' / 4';
        barLabel.textContent = 'Block progress (Work + Short break)';
      }else{
        status.textContent = 'Long Break ‚Äî well done! (15:00)';
        roundEl.textContent = 'Long Break';
        barLabel.textContent = 'Long break progress';
      }
    }

    function up(ms){ if(pomo) pomo.textContent=fmt(ms); }

    // ***** PROGRESS LOGIC *****
    function updateBar(msRemaining){
      if(mode==='work' || mode==='short'){
        var elapsed = (mode==='work') ? (WORK - msRemaining) : (WORK + (SHORT - msRemaining));
        var pct = Math.min(100, Math.max(0, (elapsed / BLOCK) * 100));
        barFill.style.width = pct.toFixed(2)+'%';
        barFill.parentElement.setAttribute('aria-valuenow', Math.round(pct));
      }else{
        var pctL = Math.min(100, Math.max(0, ((LONG - msRemaining) / LONG) * 100));
        barFill.style.width = pctL.toFixed(2)+'%';
        barFill.parentElement.setAttribute('aria-valuenow', Math.round(pctL));
      }
    }

    function tick(){
      var rem=Math.max(0, ends-Date.now());
      up(rem); updateBar(rem);
      if(rem<=0){
        clearInterval(iv); iv=null;
        if(mode==='work'){
          if(round===4){ mode='long'; startPhase(LONG); }
          else{ mode='short'; startPhase(SHORT); }
          if(toast){ toast.style.display='block'; setTimeout(function(){toast.style.display='none'}, 3000); }
        }else if(mode==='short'){
          round = Math.min(4, round+1);
          mode='work'; startPhase(WORK);
        }else{
          round = 1; mode='work'; startPhase(WORK);
        }
      }
    }

    function startPhase(dur){
      setStatus();
      if(mode==='work') setVerse();
      ends = Date.now() + dur;
      if(iv) clearInterval(iv);
      iv=setInterval(tick, 200);
      tick();
    }

    function startAll(){
      if(started && iv) return;
      started = true; mode='work'; round = (round<1||round>4)?1:round;
      startPhase(WORK);
    }
    function pauseAll(){
      if(!iv) return;
      rest=Math.max(0, ends-Date.now()); clearInterval(iv); iv=null;
    }
    function resetAll(){
      if(iv) clearInterval(iv); iv=null; started=false;
      mode='work'; round=1; up(WORK);
      barFill.style.width='0%'; setStatus();
    }
    function skipBreak(e){
      e.preventDefault();
      if(mode==='short' || mode==='long'){
        mode='work';
        if(round===4) round=1;
        startPhase(WORK);
      }
    }

    if(start) start.addEventListener('click', startAll);
    if(pause) pause.addEventListener('click', pauseAll);
    if(reset) reset.addEventListener('click', resetAll);
    if(skip)  skip.addEventListener('click', skipBreak);

    // init
    up(WORK); setStatus();
  })();

  /* =======================================================
     AUTO-HEIGHT MESSAGE FOR ONTRAPORT EMBED (SAFE TO KEEP)
     Does nothing harmful standalone; lets parent page resize iframe.
  ======================================================= */
  (function () {
    function elementBottom(el){ if(!el) return 0; var r=el.getBoundingClientRect(); return Math.ceil((window.scrollY||0)+r.bottom); }
    function pageHeight() {
      var app = document.getElementById('cr-app'); var foot = document.querySelector('footer');
      var b=document.body, d=document.documentElement;
      var h=Math.max(elementBottom(foot),elementBottom(app),b?b.scrollHeight:0,d?d.scrollHeight:0,b?b.offsetHeight:0,d?d.offsetHeight:0);
      return Math.max(0, Math.floor(h-2));
    }
    function postHeight(){ try{ window.parent.postMessage({type:"CR_HEIGHT",h:pageHeight()},"*"); }catch(e){} }
    window.addEventListener("load", postHeight);
    window.addEventListener("resize", postHeight);
    if (document.fonts && document.fonts.ready) document.fonts.ready.then(postHeight);
    Array.prototype.forEach.call(document.querySelectorAll("iframe"), function(i){ i.addEventListener("load", function(){ setTimeout(postHeight,50); setTimeout(postHeight,400); }); });
    setTimeout(postHeight,150); setTimeout(postHeight,600); setTimeout(postHeight,1500); setTimeout(postHeight,3000);
  })();
</script>
</body>
</html>
